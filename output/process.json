[
  "[SQL] Create a Common Table Expression (CTE) named `ShipmentsInLastYear` to identify all shipments that occurred within the last year (based on `ship_date`). Include `shipment_id`, `order_id`, `warehouse_id`, `customer_id` (from `orders`), `supplier_id` (by joining `shipment_items` -> `products` -> `purchase_order_items` -> `purchase_orders`), and a flag `is_delayed` (1 if `delivered_date > expected_date`, 0 otherwise).",
  "[SQL] Create a CTE named `SupplierPerformance` that aggregates data from `ShipmentsInLastYear`. For each `supplier_id`, calculate: (1) `total_shipments_count` (count of all `shipment_id`s), (2) `delayed_shipments_count` (count of `shipment_id`s where `is_delayed = 1`). Also retrieve `supplier_name` from the `suppliers` table.",
  "[SQL] Create a CTE named `SupplierDelayedWarehouses` that, for each `supplier_id`, identifies all distinct `warehouse_id`s associated with their delayed shipments from `ShipmentsInLastYear` (where `is_delayed = 1`). Join with the `warehouses` table to get `warehouse_name`s.",
  "[SQL] Create a CTE named `SupplierCustomerImpact` that, for each `supplier_id` and each `customer_id` associated with their delayed shipments (`is_delayed = 1` in `ShipmentsInLastYear`), counts the number of delayed shipments. Join with the `customers` table to get `customer_name`.",
  "[SQL] From `SupplierCustomerImpact`, for each `supplier_id`, rank customers by their `delayed_shipment_count` in descending order and select only the top 3 customers. This can be done using a window function like `ROW_NUMBER()` or `RANK()` partitioned by `supplier_id`.",
  "[ANALYZE] Combine the results from `SupplierPerformance`, `SupplierDelayedWarehouses`, and the top 3 customers from `SupplierCustomerImpact`. For each supplier, present: the supplier's name, the total number of delayed shipments, the percentage of delayed shipments (delayed_shipments_count / total_shipments_count * 100), the names of warehouses involved in those delayed shipments, and the names of the top 3 most affected customers along with their respective delayed shipment counts. If a supplier has no delayed shipments, they should not appear in the results. Handle cases where a supplier might have fewer than 3 affected customers."
]