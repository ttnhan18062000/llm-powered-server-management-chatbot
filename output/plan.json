{
  "version": "1.0",
  "nodes": [
    {
      "id": "n1_get_user_id",
      "type": "SQL",
      "label": "Retrieve User ID",
      "requires": "",
      "produces": "result_user_id",
      "input": "Retrieve the 'id' from the 'users' table for the specified 'username'. The username will be provided at runtime."
    },
    {
      "id": "n2_analyze_user_id",
      "type": "SQL_RESULT_ANALYZER",
      "label": "Extract User ID",
      "requires": "result_user_id",
      "produces": "summary_user_id",
      "input": "From the 'result_user_id' table, extract the 'id' value, which represents the user_id. This user_id will be used in subsequent queries."
    },
    {
      "id": "n3_get_high_impact_actions",
      "type": "SQL",
      "label": "Query High-Impact Actions",
      "requires": "summary_user_id",
      "produces": "result_high_impact_actions",
      "input": "Using the 'user_id' from 'summary_user_id', query the 'user_actions' table.\n1. Find actions where 'target_table' is 'orders' and join with the 'orders' table to filter for 'status' = 'cancelled'. Include order details.\n2. Find actions where 'target_table' is 'stock_movements' and join with the 'stock_movements' table to filter for 'movement_type' = 'adjustment'. Include stock movement details (warehouse_id, product_id, quantity, notes).\nCombine these two sets of results into a single output, ensuring relevant details from 'orders' and 'stock_movements' tables are included for each action, such as action timestamp, details, order_id, status, product_id, warehouse_id, movement_type, quantity, notes.\nThe query should be designed to retrieve all necessary information for the final audit report."
    },
    {
      "id": "n4_analyze_high_impact_actions",
      "type": "SQL_RESULT_ANALYZER",
      "label": "Summarize High-Impact Actions",
      "requires": "result_high_impact_actions",
      "produces": "summary_high_impact_actions",
      "input": "Review the 'result_high_impact_actions'. For each action, identify if it's an order cancellation or a stock adjustment. Extract key information such as the action timestamp, the specific action details, the affected order ID and its status, or the affected stock movement's warehouse, product, type, and quantity. Structure this information into a concise summary that highlights the nature and impact of each high-impact action."
    },
    {
      "id": "n5_present_audit",
      "type": "ANALYZER",
      "label": "Present Audit Report",
      "requires": "summary_high_impact_actions",
      "produces": "audit_report",
      "input": "Using the 'summary_high_impact_actions', consolidate and present a clear audit report.\nFor order cancellations: include the user_id, action timestamp, order_id, original order status, new status (cancelled), and any relevant details from the user_action.\nFor manual stock adjustments: include the user_id, action timestamp, stock_movement_id, warehouse_id, product_id, movement_type (adjustment), quantity changed, and notes from the stock_movement.\nEnsure the report is human-readable, highlights the user's high-impact actions, and provides sufficient detail for review."
    }
  ],
  "edges": [
    [
      "n1_get_user_id",
      "n2_analyze_user_id"
    ],
    [
      "n2_analyze_user_id",
      "n3_get_high_impact_actions"
    ],
    [
      "n3_get_high_impact_actions",
      "n4_analyze_high_impact_actions"
    ],
    [
      "n4_analyze_high_impact_actions",
      "n5_present_audit"
    ]
  ]
}