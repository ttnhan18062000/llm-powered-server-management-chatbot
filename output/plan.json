{
  "version": "1.0",
  "nodes": [
    {
      "id": "n1_get_delayed_shipments_data",
      "type": "SQL",
      "label": "Retrieve raw data on delayed shipments per supplier",
      "requires": "",
      "produces": "result_delayed_shipments_raw",
      "input": "Generate a SQL query to retrieve the following for each supplier for shipments in the last year (ship_date within the last year): supplier_id, supplier_name, total_shipments_count (total unique shipments linked to the supplier), delayed_shipments_count (total unique delayed shipments linked to the supplier, where delivered_date > expected_date), delayed_warehouses_names (comma-separated list of unique warehouse names involved in delayed shipments for that supplier), and delayed_customer_ids_list (comma-separated list of customer IDs involved in delayed shipments for that supplier, including duplicates for frequency counting). This query will join shipments, orders, order_items, products, purchase_order_items, purchase_orders, suppliers, and warehouses tables. Ensure ship_date is within the last year from CURRENT_DATE."
    },
    {
      "id": "n2_analyze_delayed_shipments",
      "type": "SQL_RESULT_ANALYZER",
      "label": "Process delayed shipment data and identify top customers",
      "requires": "result_delayed_shipments_raw",
      "produces": "summary_delayed_shipments_processed",
      "input": "Process the SQL query results from 'result_delayed_shipments_raw'. For each supplier, calculate the percentage of delayed shipments (delayed_shipments_count / total_shipments_count * 100). Parse the 'delayed_customer_ids_list' to determine the top 3 most affected customer IDs by counting the frequency of each customer ID. The output should be a structured object (e.g., JSON array) where each element represents a supplier and includes: supplier_id, supplier_name, delayed_shipments_count, percentage_delayed_shipments, delayed_warehouses_names, and a list of the top 3 customer IDs (e.g., [customer_id_1, customer_id_2, customer_id_3])."
    },
    {
      "id": "n3_get_customer_names",
      "type": "SQL",
      "label": "Retrieve names for identified top customers",
      "requires": "summary_delayed_shipments_processed",
      "produces": "result_customer_names_raw",
      "input": "Extract all unique customer IDs from the 'summary_delayed_shipments_processed' artifact. Generate a SQL query to retrieve the 'id' and 'name' for these specific customer IDs from the 'customers' table. The query should return two columns: customer_id and customer_name."
    },
    {
      "id": "n4_analyze_customer_names",
      "type": "SQL_RESULT_ANALYZER",
      "label": "Map customer IDs to names",
      "requires": "result_customer_names_raw",
      "produces": "summary_customer_names",
      "input": "Process the raw SQL results from 'result_customer_names_raw'. Create a mapping (e.g., a dictionary or JSON object) where keys are customer IDs and values are their corresponding customer names."
    },
    {
      "id": "n5_format_final_output",
      "type": "ANALYZER",
      "label": "Generate final report of suppliers and delayed shipments",
      "requires": "summary_delayed_shipments_processed,summary_customer_names",
      "produces": "final_report",
      "input": "Combine the information from 'summary_delayed_shipments_processed' and 'summary_customer_names'. For each supplier in 'summary_delayed_shipments_processed', replace the top 3 customer IDs with their corresponding names using the mapping from 'summary_customer_names'. Format the final output as a human-readable report (e.g., a markdown table or a clear list of entries) including the supplier's name, the number of delayed shipments, the percentage of delayed shipments, the warehouses that handled those delayed shipments, and the names of the top 3 most affected customers. Order the suppliers by the number of delayed shipments in descending order."
    }
  ],
  "edges": [
    [
      "n1_get_delayed_shipments_data",
      "n2_analyze_delayed_shipments"
    ],
    [
      "n2_analyze_delayed_shipments",
      "n3_get_customer_names"
    ],
    [
      "n3_get_customer_names",
      "n4_analyze_customer_names"
    ],
    [
      "n2_analyze_delayed_shipments",
      "n5_format_final_output"
    ],
    [
      "n4_analyze_customer_names",
      "n5_format_final_output"
    ]
  ]
}